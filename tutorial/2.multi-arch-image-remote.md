### 1. arm-jenk 인스턴스 도커 설정하기 ###

ec2 콘솔에서 arm-jenk 인스턴스 정보를 확인 후, 해당 인스턴스로 로그인 한다.
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/ec2-4.png)
```
$ ssh -i aws-kp-2.pem ubuntu@15.164.209.139
```

도커 데몬이 2375 포트로 서비스 할수 있도록 docker.service 파일을 수정한다. 
```
ubuntu$ cd /lib/systemd/system
ubuntu$ sudo su
ubuntu$ sed -i 's|ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock|\
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H 0.0.0.0:2375|' docker.service
```

도커 데몬을 재시작한다. 
```
ubuntu$ sudo systemctl daemon-reload
ubuntu$ sudo systemctl restart docker.service
```

listen 상태로 열려있는 포트를 확인한다. 
```
ubuntu$ sudo netstat -ltup
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 _localdnsstub:domain    0.0.0.0:*               LISTEN      518/systemd-resolve
tcp        0      0 _localdnsproxy:domain   0.0.0.0:*               LISTEN      518/systemd-resolve
tcp6       0      0 [::]:2375               [::]:*                  LISTEN      6271/dockerd
tcp6       0      0 [::]:ssh                [::]:*                  LISTEN      1/init
udp        0      0 _localdnsproxy:domain   0.0.0.0:*                           518/systemd-resolve
udp        0      0 _localdnsstub:domain    0.0.0.0:*                           518/systemd-resolve
udp        0      0 ip-10-0-102-180.:bootpc 0.0.0.0:*                           710/systemd-network
udp        0      0 localhost:323           0.0.0.0:*                           900/chronyd
udp6       0      0 ip6-localhost:323       [::]:*                              900/chronyd
```

x86-jenk 인스턴스로 로그인하여 remote docker 를 이용하여 nginx 를 실행한다. 
```
$ ssh -i aws-kp-2.pem ubuntu@3.38.186.174

ubuntu$ sudo docker -H 10.0.102.180 run -p 80:80 --rm --name nginx nginx
```
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/docker-remote-1.png)


### 2. buildx remote 빌더 설정하기 ###

x86-jenk 인스턴스로 로그인하여 x86 이미지를 빌드하고, graviton 의 경우 docker의 remote 설정을 통해 arm-jenk 인스턴스에서 이미지를 빌드할 예정이다.   
```
ubuntu$ sudo docker buildx create --name local_remote_builder \
--node x86-jenk \
--platform linux/amd64

ubuntu$ sudo docker buildx create --name local_remote_builder \
--append \
--node arm-jenk \
--platform linux/arm64 tcp://10.0.102.180
```

local_remote_builder 빌더의 설정을 확인한다. 
```
ubuntu$ sudo docker buildx ls
NAME/NODE              DRIVER/ENDPOINT                   STATUS     BUILDKIT   PLATFORMS
local_remote_builder   docker-container
 \_ x86-jenk            \_ unix:///var/run/docker.sock   inactive              linux/amd64*
 \_ arm-jenk            \_ tcp://10.0.102.180:2375       inactive              linux/arm64*
default*               docker
 \_ default             \_ default                       running    v0.17.3    linux/amd64 (+4), linux/386


ubuntu$ sudo docker buildx use local_remote_builder

ubuntu$ sudo docker buildx inspect --bootstrap
Name:          local_remote_builder
Driver:        docker-container
Last Activity: 2024-12-16 08:02:20 +0000 UTC

Nodes:
Name:                  x86-jenk
Endpoint:              unix:///var/run/docker.sock
Status:                running
BuildKit daemon flags: --allow-insecure-entitlement=network.host
BuildKit version:      v0.18.1
Platforms:             linux/amd64*, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386
Labels:
 org.mobyproject.buildkit.worker.executor:         oci
 org.mobyproject.buildkit.worker.hostname:         2ef2c94b5364
 org.mobyproject.buildkit.worker.network:          host
 org.mobyproject.buildkit.worker.oci.process-mode: sandbox
 org.mobyproject.buildkit.worker.selinux.enabled:  false
 org.mobyproject.buildkit.worker.snapshotter:      overlayfs
GC Policy rule#0:
 All:            false
 Filters:        type==source.local,type==exec.cachemount,type==source.git.checkout
 Keep Duration:  48h0m0s
 Max Used Space: 488.3MiB
GC Policy rule#1:
 All:            false
 Keep Duration:  1440h0m0s
 Reserved Space: 953.7MiB
 Max Used Space: 6.519GiB
 Min Free Space: 1.863GiB
GC Policy rule#2:
 All:            false
 Reserved Space: 953.7MiB
 Max Used Space: 6.519GiB
 Min Free Space: 1.863GiB
GC Policy rule#3:
 All:            true
 Reserved Space: 953.7MiB
 Max Used Space: 6.519GiB
 Min Free Space: 1.863GiB

Name:                  arm-jenk
Endpoint:              tcp://10.0.102.180:2375
Status:                running
BuildKit daemon flags: --allow-insecure-entitlement=network.host
BuildKit version:      v0.18.1
Platforms:             linux/arm64*, linux/arm/v7, linux/arm/v6
Labels:
 org.mobyproject.buildkit.worker.executor:         oci
 org.mobyproject.buildkit.worker.hostname:         d4ab14b21381
 org.mobyproject.buildkit.worker.network:          host
 org.mobyproject.buildkit.worker.oci.process-mode: sandbox
 org.mobyproject.buildkit.worker.selinux.enabled:  false
 org.mobyproject.buildkit.worker.snapshotter:      overlayfs
GC Policy rule#0:
 All:            false
 Filters:        type==source.local,type==exec.cachemount,type==source.git.checkout
 Keep Duration:  48h0m0s
 Max Used Space: 488.3MiB
GC Policy rule#1:
 All:            false
 Keep Duration:  1440h0m0s
 Reserved Space: 953.7MiB
 Max Used Space: 5.588GiB
 Min Free Space: 1.863GiB
GC Policy rule#2:
 All:            false
 Reserved Space: 953.7MiB
 Max Used Space: 5.588GiB
 Min Free Space: 1.863GiB
GC Policy rule#3:
 All:            true
 Reserved Space: 953.7MiB
 Max Used Space: 5.588GiB
 Min Free Space: 1.863GiB
```

```
sudo docker buildx build --platform=linux/amd64,linux/arm64/v8 --push -t spring-ai .

```


## 레퍼런스 ##

* [sed edit file in-place](https://stackoverflow.com/questions/12696125/sed-edit-file-in-place)
* [docker daemon 설정을 이용해 원격으로 docker 이용하기](https://senticoding.tistory.com/94)
