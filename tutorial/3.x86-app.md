## [ALB 컨트롤러 설치하기](https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/) ##
* https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases
```
$ ACCOUNT_ID=$(aws sts get-caller-identity | grep "Account" | cut -d ':' -f 2 | sed 's/\"//g; s/,//g; s/ //g')
$ LBC_VERSION="v2.10.1"
$ curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/${LBC_VERSION}/docs/install/iam_policy.json

$ aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \
    --policy-document file://iam_policy.json

$ eksctl create iamserviceaccount \
  --cluster=eks-grv-mig \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --role-name AmazonEKSLoadBalancerControllerRole \
  --attach-policy-arn=arn:aws:iam::${ACCOUNT_ID}:policy/AWSLoadBalancerControllerIAMPolicy \
  --approve

```






## spring-ai 배포하기  ##

관리노드(로컬 PC) 에서 아래 명령어를 실행한다.
```
$ cat <<EOF > spring-ai.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: spring-ai
  namespace: default
  labels:
    app: spring-ai
spec:
  replicas: 4
  selector:
    matchLabels:
      app: spring-ai
  template:
    metadata:
      labels:
        app: spring-ai
    spec:
      containers:
        - name: spring-ai
          image: 499514681453.dkr.ecr.ap-northeast-2.amazonaws.com/spring-ai
          ports:
            - containerPort: 8080
          imagePullPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: spring-ai
  namespace: default
  labels:
    app: spring-ai
spec:
  type: NodePort
  selector:
    app: spring-ai
  ports:
    - port: 80
      targetPort: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: spring-ai
  namespace: default
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/load-balancer-name: spring-ai-alb
    alb.ingress.kubernetes.io/healthcheck-path: /actuator/health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '5'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '3'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
spec:
  rules:
   - http:
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: spring-ai
              port:
                number: 80
EOF
```
```
$ kubectl apply -f spring-ai.yaml
```

```
$ kubectl get all
NAME                            READY   STATUS    RESTARTS   AGE
pod/nginx-676b6c5bbc-swdnj      1/1     Running   0          37m
pod/spring-ai-c854d646b-5s956   1/1     Running   0          2m2s
pod/spring-ai-c854d646b-kmzqg   1/1     Running   0          2m2s
pod/spring-ai-c854d646b-pxztm   1/1     Running   0          2m2s
pod/spring-ai-c854d646b-qs4xw   1/1     Running   0          2m2s

NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service/kubernetes   ClusterIP   172.20.0.1       <none>        443/TCP        49m
service/spring-ai    NodePort    172.20.185.175   <none>        80:31744/TCP   2m2s

NAME                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx       1/1     1            1           37m
deployment.apps/spring-ai   4/4     4            4           2m2s

NAME                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-676b6c5bbc      1         1         1       37m
replicaset.apps/spring-ai-c854d646b   4         4         4       2m2s
```


## 참고자료 ##

* [Route internet traffic with AWS Load Balancer Controller](https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html)
* [AWS Load Balancer Controller 사용](https://nauco.tistory.com/89)


