## buildx ##

아래 명령어를 이용하여 springboot-ai 이라는 이름의 ecr 레포지토리를 만들어준다.
```
$ aws ecr create-repository --repository-name springboot-ai
```

[실행결과]
```
{
    "repository": {
        "repositoryArn": "arn:aws:ecr:ap-northeast-2:000000000000:repository/springboot-ai",
        "registryId": "000000000000",
        "repositoryName": "eks-grv-mig",
        "repositoryUri": "000000000000.dkr.ecr.ap-northeast-2.amazonaws.com/springboot-ai",
        "createdAt": "2024-12-11T02:43:40.715000+09:00",
        "imageTagMutability": "MUTABLE",
        "imageScanningConfiguration": {
            "scanOnPush": false
        },
        "encryptionConfiguration": {
            "encryptionType": "AES256"
        }
    }
}
```

EC2 콘설에서 인스턴스 리스트를 조회하고,
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/ec2-1.png)

인스턴스가 ECR 에 이미지를 푸시할 수 있도록 아래와 같이 EC2ServiceRoleECR 권한을 만들어서 x86-jenk, arm-jenk 인스턴스에 attach 한다.   
```
$ cat <<EOF >> ec2-service-policy.json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": "sts:AssumeRole",
      "Principal": {
        "Service": ["ec2.amazonaws.com"]
      },
      "Effect": "Allow"
    }
  ]
}
EOF

$ aws iam create-role --role-name EC2ServiceRoleECR --assume-role-policy-document file://ec2-service-policy.json

$ aws iam attach-role-policy --role-name EC2ServiceRoleECR --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess

$ aws iam create-instance-profile --instance-profile-name EC2ServiceRoleECR

$ aws iam add-role-to-instance-profile --role-name EC2ServiceRoleECR --instance-profile-name EC2ServiceRoleECR
```
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/ec2-2.png)

ec2 콘솔에서 보이는 인스턴스 중 Name 이 x86-jenk 인 인스턴스를 선택하고, ssh를 이용하여 로그인 한다.
```
$ ssh -i aws-kp-2.pem ubuntu@ec2-43-203-216-190.ap-northeast-2.compute.amazonaws.com
```

멀티 아키텍처 컨테이너 이미지를 만들기 위해서는 buildx 플러그인을 설치해야 한다. 
```
ubuntu$ sudo apt-get install docker-buildx-plugin
```

플러그인을 설치한 이후 아래와 같이 빌더를 하나 만들어 준다. 이 빌더는 멀티 아키텍처 이미지를 만드는 데 사용된다.  
```
ubuntu$ sudo docker buildx create --name multiarch --bootstrap --use

ubuntu$ sudo docker buildx inspect multiarch
```


aws cli 유틸리티를 설치하고 ecr 에 로그인한다.
```
ubuntu$ ACCOUNT_ID=`aws sts get-caller-identity|jq -r ".Account"`; REGION=ap-northeast-2

ubuntu$ aws ecr get-login-password --region $REGION | docker login --username AWS \
--password-stdin $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com
```



arm64 및 amd64 용 멀티이미지를 만들어서 docker hub 에 푸시한다.
```
ubuntu$ docker buildx build --push \
  --platform linux/arm64,linux/amd64 \
  --tag controlftp/vmg:v14 .
```



## 인스턴스 타입별로 빌드하기 ##


## 레퍼런스 ##
* [Multi-Architecture Docker Image](https://medium.com/illumination/multi-architecture-docker-image-3637ba05e5eb)
* [Integrate Jenkins with Amazon ECR](https://medium.com/@lilnya79/integrate-jenkins-with-amazon-ecr-4946ca5b86e1)
* https://www.eksworkshop.com/docs/fundamentals/managed-node-groups/graviton/scheduling-graviton
