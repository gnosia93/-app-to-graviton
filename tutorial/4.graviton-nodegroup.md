## Graviton 노드 추가 ##
### 노드 확인 ###

```
$ kubectl get nodes
```
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/kubectl-getnode-1.png)

### Grvaviton 노드 생성 ###

eks.tf 파일에서 ng-arm 블록의 주석을 풀어주고 노드 그룹을 생성한다.
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/yaml-1.png)

```
$ cd eks-grv-mig/tf

$ terraform apply --auto-approve
```

### 추가된 노드 확인 ###
```
$ kubectl get nodes
```
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/kubectl-getnode-2.png)
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/eks-ng-1.png)

## 어플리케이션 배포하기 ##
성능 테스트를 위해 그라비톤 노드에 어플리케이션을 배포한다.  
```
cat <<_EOF > spring-ai-graviton.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: spring-ai-graviton
  namespace: default
  labels:
    app: spring-ai-graviton
spec:
  replicas: 4
  selector:
    matchLabels:
      app: spring-ai-graviton
  template:
    metadata:
      labels:
        app: spring-ai-graviton    
    spec:
      containers:
        - name: spring-ai
          image: 499514681453.dkr.ecr.ap-northeast-2.amazonaws.com/spring-ai
          ports:
            - containerPort: 8080
          imagePullPolicy: Always

      nodeSelector:
        kubernetes.io/arch: arm64
---
apiVersion: v1
kind: Service
metadata:
  name: spring-ai-graviton
  namespace: default
  labels:
    app: spring-ai-graviton
spec:
  type: NodePort
  selector:
    app: spring-ai-graviton
  ports:
    - port: 80
      targetPort: 8080
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: spring-ai
  namespace: default
  annotations:
#    kubernetes.io/ingress.class: alb
    spec.ingressClassName: alb
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/load-balancer-name: spring-ai-alb
    alb.ingress.kubernetes.io/healthcheck-path: /actuator/health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '5'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '3'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
spec:
  rules:
   - http:
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: spring-ai-graviton
              port:
                number: 80
_EOF
```

```
kubectl apply -f spring-ai-graviton.yaml
```
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/kubectl-getnode-5.png)

## 레퍼런스 ##

* https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-managed-node-group.html
* https://eksctl.io/usage/custom-ami-support/#setting-the-node-ami-id
