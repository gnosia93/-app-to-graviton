## 사전 준비 ##

```
eksctl create iamserviceaccount \
  --cluster eks-grv-mig \
  --namespace kube-system \
  --name ebs-csi-controller-sa \
  --role-name AmazonEKS_EBS_CSI_DriverRole \
  --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \
  --role-only \
  --override-existing-serviceaccounts \
  --approve 
```
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/addon-csi-1.png)
![](https://github.com/gnosia93/eks-grv-mig/blob/main/tutorial/images/addon-csi-2.png)

```
// IRSA 확인
eksctl get iamserviceaccount --cluster eks-grv-mig
```

```
ACCOUNT_ID=$(aws sts get-caller-identity | grep "Account" | cut -d ':' -f 2 | sed 's/\"//g; s/,//g; s/ //g')

eksctl create addon --name aws-ebs-csi-driver\
 --cluster eks-grv-mig \
 --service-account-role-arn arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKS_EBS_CSI_DriverRole\
 --force
```
****
PVC 상태가 pending 으로 표시되면, EC2:CreateVolume 권한을 넣어줘야 한다.

NodeGroup Role 에 다가 넣어주면 된다. 그런데 좀 이상하네. ㅜㅜ ..왜 ? 
ng-x86-eks-node-group-20241212035658596800000001 
****



## [프로메테우스 설치하기](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/deploy-prometheus.html) ##

```
$ kubectl create namespace prometheus

$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
$ helm repo update prometheus-community

$ helm upgrade -i prometheus prometheus-community/prometheus \
    --namespace prometheus \
    --set alertmanager.persistence.storageClass="gp2" \
    --set server.persistentVolume.storageClass="gp2"
```

```
$ kubectl --namespace=prometheus port-forward deploy/prometheus-server 9090
```




## 레퍼런스 ##

* https://incredible.ai/kubernetes/2020/09/08/Prometheus_And_Grafana/
* [EKS에 Helm으로 Prometheus 설치하기](https://velog.io/@brillog/EKS%EC%97%90-Helm%EC%9C%BC%EB%A1%9C-Prometheus-Grafana-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0)
* [Kubernetes Cluster Monitoring through Prometheus: External Monitoring](https://vivek-raj.medium.com/kubernetes-cluster-monitoring-through-prometheus-external-monitoring-54ff01a8b727)
* [Service Account와 Secret 생성 - 해결](https://tech-recipe.tistory.com/8)
* [AWS EBS CSI Driver 설치 및 구성하기](https://velog.io/@rockwellvinca/EKS-AWS-EBS-CSI-Driver-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EA%B5%AC%EC%84%B1)
